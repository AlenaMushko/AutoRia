service: serverless
frameworkVersion: "3"

plugins:
  - serverless-offline
  - serverless-esbuild
  - serverless-dotenv-plugin

provider:
  name: aws
  runtime: nodejs18.x
  region: us-east-1
  environment:
  stage: ${opt:stage, 'dev'}

  iamRoleStatements:
    - Effect: "Allow"
      Action:
        - "s3:PutObject"
        - "s3:GetObject"
        - "s3:DeleteObject"
      Resource:
        - "arn:aws:s3:::your-user-avatars-bucket-name/*"
        - "arn:aws:s3:::your-cars-images-videos-bucket-name/*"

custom:
  dotenv:
    path: ../.env
  esbuild:
    bundle: true
    minify: true
    sourcemap: true
    exclude: [ 'aws-sdk' ]
    target: 'es2020'

functions:
  getAllUsers:
    handler: src/handlers/user/getAllUsers.handler
    events:
      - httpApi:
          path: /users
          method: GET

  getAllCars:
    handler: src/handlers/car/getAllCars.handler
    events:
      - httpApi:
          path: /cars
          method: GET

  getQueryPrice:
    handler: src/handlers/car/getQueryPrice.handler
    events:
      - httpApi:
          path: /cars/region-price
          method: GET

  getQueryCount:
    handler: src/handlers/car/getQueryCount.handler
    events:
      - httpApi:
          path: /cars/{carId}/count
          method: GET

  uploadFileAvatar:
    handler: src/handlers/user/uploadFileAvatar.handler
    events:
      - httpApi:
          path: /users/{userId}/avatar
          method: POST

#  uploadFileCar:
#    handler: src/handlers/car/uploadFileCar.handler
#    events:
#      - httpApi:
#          path: /cars/{carId}/photo
#          method: POST
#
#  uploadVideoCar:
#    handler: src/handlers/car/uploadVideoCar.handler
#    events:
#      - httpApi:
#          path: /cars/{carId}/video
#          method: POST

  cronOldTokensRemover:
    handler: src/handlers/user/cronOldTokensRemover.handler
    events:
      - schedule:
          rate: cron(0 3 ? * MON *)
          enabled: false

  cronUpdatePrice:
    handler: src/handlers/car/cronUpdatePrice.handler
    events:
      - schedule:
          rate: cron(20 8 * * ? *)
          enabled: false

resources:
  Resources:
    NewResource:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: auto-ria-serverless

